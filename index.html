<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿è½¬ç›˜ - æŠ½å¥–å¥–åŠ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* ç®€æ´ä¸»é¢˜ */
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --primary: #409eff;
            --primary-hover: #66b1ff;
            --text-color: #303133;
            --text-secondary: #606266;
            --border-color: #dcdfe6;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        /* å¡é€šä¸»é¢˜ */
        [data-theme="cartoon"] {
            --bg-color: #fff9e6;
            --card-bg: #ffffff;
            --primary: #ff6b9d;
            --primary-hover: #ff8fb3;
            --text-color: #ff6b6a;
            --text-secondary: #ffa502;
            --border-color: #ffced4;
            --shadow: 0 4px 16px rgba(255, 107, 157, 0.2);
        }

        /* ä¸­å›½æ°‘æ—é£ä¸»é¢˜ */
        [data-theme="chinese"] {
            --bg-color: #fef5e7;
            --card-bg: #fffaf0;
            --primary: #c0392b;
            --primary-hover: #e74c3c;
            --text-color: #8b0000;
            --text-secondary: #d35400;
            --border-color: #f39c12;
            --shadow: 0 4px 20px rgba(192, 57, 43, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 20px;
        }

        h1, h2, h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2em;
            color: var(--primary);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .option-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }

        .option-row input[type="text"] {
            flex: 2;
        }

        .option-row input[type="number"] {
            flex: 1;
        }

        .option-row span {
            font-weight: bold;
            color: var(--text-secondary);
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .remove-btn:hover {
            transform: scale(1.1);
        }

        .remove-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .add-btn:hover {
            background: var(--primary-hover);
        }

        .add-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .total-hint {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            padding: 10px;
            border-radius: 8px;
        }

        .total-hint.valid {
            background: #d4edda;
            color: #155724;
        }

        .total-hint.invalid {
            background: #f8d7da;
            color: #721c24;
        }

        /* ä¸»é¢˜é€‰æ‹© */
        .theme-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .theme-option {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-option:hover {
            border-color: var(--primary);
        }

        .theme-option.selected {
            border-color: var(--primary);
            background: var(--bg-color);
        }

        .theme-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
        }

        .theme-preview.simple {
            background: linear-gradient(135deg, #409eff, #67c23a);
        }

        .theme-preview.cartoon {
            background: linear-gradient(135deg, #ff6b9d, #ffd93d, #6bcfff);
        }

        .theme-preview.chinese {
            background: linear-gradient(135deg, #c0392b, #f39c12, #e74c3c);
        }

        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #909399;
            color: white;
        }

        .btn-secondary:hover {
            background: #a6a9ad;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number {
            background: var(--primary);
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--border-color);
        }

        .step.active + .step .step-line {
            background: var(--primary);
        }

        /* è½¬ç›˜æ ·å¼ */
        .wheel-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin: 30px auto;
        }

        .wheel-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid var(--primary);
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        #wheel-canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: var(--primary);
            z-index: 5;
        }

        /* æŠ½å¥–æŒ‰é’® */
        .spin-button {
            display: block;
            margin: 20px auto;
            padding: 18px 50px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 30px;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .spin-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .spin-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .chances-info {
            text-align: center;
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .chances-info strong {
            color: var(--primary);
            font-size: 20px;
        }

        /* å¼¹çª— */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal h2 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .modal p {
            font-size: 20px;
            color: var(--text-color);
            margin-bottom: 25px;
        }

        .modal-btn {
            padding: 12px 40px;
            font-size: 16px;
            border-radius: 25px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            background: var(--primary-hover);
        }

        /* çƒŸèŠ±ç”»å¸ƒ */
        #fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* é¡µé¢åˆ‡æ¢ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ç¼–è¾‘æŒ‰é’® */
        .edit-btn {
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: #e67e22;
        }

        /* å¯¼å‡ºæŒ‰é’® */
        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #229954;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            .wheel-container {
                width: 280px;
                height: 280px;
                margin: 20px auto;
            }

            .option-row {
                flex-direction: column;
                align-items: stretch;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            h1 {
                font-size: 1.5em;
            }

            h3 {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>

    <div class="container">
        <!-- é¡µé¢1ï¼šè¾“å…¥é€‰é¡¹ -->
        <div id="page1" class="page active">
            <div class="card">
                <h1>ğŸ¡ å¹¸è¿è½¬ç›˜é…ç½®</h1>
                <h3>ç¬¬ä¸€æ­¥ï¼šè®¾ç½®å¥–åŠ±é€‰é¡¹å’Œæ¦‚ç‡</h3>

                <div class="steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                    </div>
                    <div class="step">
                        <div class="step-line"></div>
                        <div class="step-number">2</div>
                    </div>
                    <div class="step">
                        <div class="step-line"></div>
                        <div class="step-number">3</div>
                    </div>
                </div>

                <form id="options-form">
                    <div id="options-container">
                        <!-- é€‰é¡¹è¡Œä¼šåŠ¨æ€æ·»åŠ  -->
                    </div>

                    <div class="total-hint" id="total-hint">
                        å½“å‰æ€»è®¡ï¼š0% ï¼ˆéœ€è¦è¾¾åˆ° 100%ï¼‰
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="add-btn" id="add-option-btn">
                            <span>â• æ·»åŠ é€‰é¡¹</span>
                        </button>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-primary" id="next-btn" disabled>
                            ä¸‹ä¸€æ­¥ â†’
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- é¡µé¢2ï¼šè®¾ç½®æ ‡é¢˜å’Œä¸»é¢˜ -->
        <div id="page2" class="page">
            <div class="card">
                <h1 id="config-title">ğŸ¡ å¹¸è¿è½¬ç›˜é…ç½®</h1>
                <h3>ç¬¬äºŒæ­¥ï¼šè®¾ç½®æ ‡é¢˜å’Œä¸»é¢˜</h3>

                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-line"></div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                    </div>
                    <div class="step">
                        <div class="step-line"></div>
                        <div class="step-number">3</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="wheel-title">è½¬ç›˜æ ‡é¢˜</label>
                    <input type="text" id="wheel-title" value="å¹¸è¿å¤§æŠ½å¥–" placeholder="è¯·è¾“å…¥è½¬ç›˜æ ‡é¢˜">
                </div>

                <div class="form-group">
                    <label>é€‰æ‹©ä¸»é¢˜</label>
                    <div class="theme-options">
                        <div class="theme-option selected" data-theme="simple">
                            <div class="theme-preview simple"></div>
                            <div>ç®€æ´</div>
                        </div>
                        <div class="theme-option" data-theme="cartoon">
                            <div class="theme-preview cartoon"></div>
                            <div>å¡é€š</div>
                        </div>
                        <div class="theme-option" data-theme="chinese">
                            <div class="theme-preview chinese"></div>
                            <div>ä¸­å›½æ°‘æ—é£</div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="prev-btn">
                        â† ä¸Šä¸€æ­¥
                    </button>
                    <button type="button" class="btn btn-primary" id="generate-btn">
                        ç”Ÿæˆè½¬ç›˜ ğŸ¡
                    </button>
                </div>
            </div>
        </div>

        <!-- é¡µé¢3ï¼šè½¬ç›˜æ¸¸æˆ -->
        <div id="page3" class="page">
            <div class="card">
                <h1 id="game-title">ğŸ¡ å¹¸è¿å¤§æŠ½å¥–</h1>
                <div class="header-buttons">
                    <button type="button" class="edit-btn" id="edit-btn">âœï¸ ç¼–è¾‘</button>
                    <button type="button" class="export-btn" id="export-btn">ğŸ’¾ ä¿å­˜åˆ°æœ¬åœ°</button>
                </div>

                <div class="chances-info">
                    å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š<strong id="chances-left">3</strong> æ¬¡
                </div>

                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel" id="wheel">
                        <canvas id="wheel-canvas"></canvas>
                    </div>
                    <div class="wheel-center">GO</div>
                </div>

                <button type="button" class="spin-button" id="spin-btn">
                    ğŸ¯ å¼€å§‹æŠ½å¥–
                </button>
            </div>
        </div>
    </div>

    <!-- ç»“æœå¼¹çª— -->
    <div class="modal-overlay" id="result-modal">
        <div class="modal">
            <h2>ğŸ‰ æ­å–œæ‚¨ï¼</h2>
            <p id="result-text">æ‚¨æŠ½ä¸­äº†ï¼š</p>
            <button type="button" class="modal-btn" id="modal-ok-btn">çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- æœºä¼šç”¨å®Œå¼¹çª— -->
    <div class="modal-overlay" id="no-chances-modal">
        <div class="modal">
            <h2>ğŸ˜… å¾ˆæŠ±æ­‰</h2>
            <p>ä»Šå¤©çš„æŠ½å¥–æœºä¼šç”¨å®Œäº†</p>
            <button type="button" class="modal-btn" id="no-chances-ok-btn">çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        // ============ å…¨å±€çŠ¶æ€ ============
        const state = {
            options: [], // { name: string, probability: number }
            title: '',
            theme: 'simple',
            chancesLeft: 3,
            isSpinning: false
        };

        // è½¬ç›˜é¢œè‰²
        const segmentColors = [
            '#FF6B6A', '#4ECDC4', '#45B7D1', '#FFA07A',
            '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
            '#F8B4D9', '#52B788'
        ];

        // ä¸­å›½é£é¢œè‰²
        const chineseColors = [
            '#C0392B', '#E74C3C', '#F39C12', '#E67E22',
            '#D35400', '#C0392B', '#E74C3C', '#F39C12'
        ];

        // å¡é€šé¢œè‰²
        const cartoonColors = [
            '#FF6B9D', '#FFD93D', '#6BCFFF', '#FF6B6A',
            '#4ECDC4', '#95E1D3', '#FFA07A', '#DDA0DD'
        ];

        // ============ DOM å…ƒç´  ============
        const optionsContainer = document.getElementById('options-container');
        const addOptionBtn = document.getElementById('add-option-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const generateBtn = document.getElementById('generate-btn');
        const wheelTitleInput = document.getElementById('wheel-title');
        const themeOptions = document.querySelectorAll('.theme-option');
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spin-btn');
        const editBtn = document.getElementById('edit-btn');
        const exportBtn = document.getElementById('export-btn');
        const resultModal = document.getElementById('result-modal');
        const noChancesModal = document.getElementById('no-chances-modal');
        const resultText = document.getElementById('result-text');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const noChancesOkBtn = document.getElementById('no-chances-ok-btn');
        const totalHint = document.getElementById('total-hint');
        const chancesLeftEl = document.getElementById('chances-left');
        const gameTitle = document.getElementById('game-title');
        const configTitle = document.getElementById('config-title');
        const fireworksCanvas = document.getElementById('fireworks-canvas');
        const fireworksCtx = fireworksCanvas.getContext('2d');
        const wheelCanvas = document.getElementById('wheel-canvas');
        let wheelCtx = null; // å°†åœ¨ initWheelCanvas() ä¸­åˆå§‹åŒ–

        // ============ åˆå§‹åŒ– ============
        function init() {
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            resizeFireworksCanvas();
            initWheelCanvas();
            window.addEventListener('resize', () => {
                resizeFireworksCanvas();
                initWheelCanvas();
            });

            // åŠ è½½ä¿å­˜çš„çŠ¶æ€
            loadState();

            // å¦‚æœæ˜¯å¯¼å‡ºçš„æ–‡ä»¶ï¼Œç›´æ¥è¿›å…¥æ¸¸æˆç•Œé¢
            if (state.isExported && state.options.length > 0) {
                // è®¾ç½®æ ‡é¢˜
                gameTitle.textContent = `ğŸ¡ ${state.title}`;

                // è®¾ç½®ä¸»é¢˜
                document.documentElement.setAttribute('data-theme', state.theme);

                // ç»˜åˆ¶è½¬ç›˜
                drawWheel();

                // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
                showPage(3);

                // è®¾ç½®äº‹ä»¶ç›‘å¬
                setupEventListeners();

                // éšè—ç¼–è¾‘å’Œå¯¼å‡ºæŒ‰é’®ï¼ˆå¯¼å‡ºçš„æ–‡ä»¶ä¸éœ€è¦è¿™äº›ï¼‰
                editBtn.style.display = 'none';
                exportBtn.style.display = 'none';

                return;
            }

            // åˆå§‹åŒ–é€‰é¡¹è¡Œï¼ˆ3ä¸ªï¼‰
            if (state.options.length === 0) {
                addOptionRow('æ¸¸æˆæ—¶é—´1å°æ—¶', 20);
                addOptionRow('é›¶ç”¨é’±10å—', 20);
                addOptionRow('çœ‹ä¸€åœºç”µå½±', 20);
                addOptionRow('ä¹°ä¸€ä¸ªç©å…·', 20);
                addOptionRow('æŠ¥åè¯¾å¤–ç­', 20);
            } else {
                state.options.forEach(opt => addOptionRow(opt.name, opt.probability));
            }

            // åˆå§‹åŒ–ä¸»é¢˜
            document.documentElement.setAttribute('data-theme', state.theme);

            // æ›´æ–°æ€»è®¡æ˜¾ç¤º
            updateTotalHint();

            // å¦‚æœæœ‰ä¿å­˜çš„æ ‡é¢˜
            if (state.title) {
                wheelTitleInput.value = state.title;
            }

            // äº‹ä»¶ç›‘å¬
            setupEventListeners();
        }

        // ============ é€‰é¡¹è¡Œç®¡ç† ============
        function addOptionRow(name = '', probability = 0) {
            const row = document.createElement('div');
            row.className = 'option-row';
            row.innerHTML = `
                <input type="text" class="option-name" placeholder="é€‰é¡¹åç§°" value="${name}" required>
                <input type="number" class="option-prob" placeholder="%" min="0" max="100" value="${probability}" required>
                <span>%</span>
                <button type="button" class="remove-btn" ${optionsContainer.children.length >= 5 ? 'disabled' : ''}>Ã—</button>
            `;

            optionsContainer.appendChild(row);

            // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
            updateRemoveButtons();

            // æ·»åŠ è¾“å…¥ç›‘å¬
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', updateTotalHint);
            });

            // åˆ é™¤æŒ‰é’®äº‹ä»¶
            const removeBtn = row.querySelector('.remove-btn');
            removeBtn.addEventListener('click', () => {
                if (optionsContainer.children.length > 3) {
                    row.remove();
                    updateRemoveButtons();
                    updateTotalHint();
                }
            });
        }

        function updateRemoveButtons() {
            const rows = optionsContainer.querySelectorAll('.option-row');
            rows.forEach((row, index) => {
                const btn = row.querySelector('.remove-btn');
                btn.disabled = rows.length <= 3;
            });

            // æ›´æ–°æ·»åŠ æŒ‰é’®çŠ¶æ€
            addOptionBtn.disabled = rows.length >= 5;
        }

        function updateTotalHint() {
            const probs = Array.from(optionsContainer.querySelectorAll('.option-prob'))
                .map(input => parseInt(input.value) || 0);
            const total = probs.reduce((sum, val) => sum + val, 0);

            totalHint.textContent = `å½“å‰æ€»è®¡ï¼š${total}% ${total === 100 ? 'âœ“' : total > 100 ? '(è¶…è¿‡100%)' : '(éœ€è¦è¾¾åˆ°100%)'}`;
            totalHint.className = `total-hint ${total === 100 ? 'valid' : 'invalid'}`;

            nextBtn.disabled = total !== 100;
        }

        // ============ äº‹ä»¶ç›‘å¬ ============
        function setupEventListeners() {
            // æ·»åŠ é€‰é¡¹
            addOptionBtn.addEventListener('click', () => {
                if (optionsContainer.children.length < 5) {
                    addOptionRow('', 0);
                    updateTotalHint();
                }
            });

            // ä¸‹ä¸€æ­¥
            nextBtn.addEventListener('click', goToPage2);

            // ä¸Šä¸€æ­¥
            prevBtn.addEventListener('click', goToPage1);

            // ç”Ÿæˆè½¬ç›˜
            generateBtn.addEventListener('click', generateWheel);

            // ä¸»é¢˜é€‰æ‹©
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    themeOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    state.theme = option.dataset.theme;
                    document.documentElement.setAttribute('data-theme', state.theme);
                });
            });

            // é¡µé¢åˆ‡æ¢æ—¶é‡ç»˜è½¬ç›˜ï¼ˆå¦‚æœå·²ç”Ÿæˆï¼‰
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.target.id === 'page3' && mutation.target.classList.contains('active')) {
                        // è½¬ç›˜é¡µé¢æ˜¾ç¤ºæ—¶ï¼Œç¡®ä¿è½¬ç›˜å·²ç»˜åˆ¶
                        if (state.options.length > 0) {
                            drawWheel();
                        }
                    }
                });
            });

            document.querySelectorAll('.page').forEach(page => {
                observer.observe(page, { attributes: true, attributeFilter: ['class'] });
            });

            // å¼€å§‹æŠ½å¥–
            spinBtn.addEventListener('click', spin);

            // ç¼–è¾‘æŒ‰é’®
            editBtn.addEventListener('click', goToPage1);

            // å¯¼å‡ºæŒ‰é’®
            exportBtn.addEventListener('click', exportHTML);

            // å¼¹çª—æŒ‰é’®
            modalOkBtn.addEventListener('click', () => {
                resultModal.classList.remove('show');
            });

            noChancesOkBtn.addEventListener('click', () => {
                noChancesModal.classList.remove('show');
                // é‡ç½®æ¬¡æ•°
                state.chancesLeft = 3;
                updateChancesDisplay();
            });
        }

        // ============ é¡µé¢åˆ‡æ¢ ============
        function goToPage1() {
            saveState();
            showPage(1);
        }

        function goToPage2() {
            saveState();
            showPage(2);
        }

        function showPage(pageNum) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(`page${pageNum}`).classList.add('active');
        }

        // ============ ç”Ÿæˆè½¬ç›˜ ============
        function generateWheel() {
            // æ”¶é›†æ•°æ®
            const rows = optionsContainer.querySelectorAll('.option-row');
            state.options = Array.from(rows).map(row => ({
                name: row.querySelector('.option-name').value,
                probability: parseInt(row.querySelector('.option-prob').value)
            }));

            state.title = wheelTitleInput.value || 'å¹¸è¿å¤§æŠ½å¥–';

            // ä¿å­˜çŠ¶æ€
            saveState();

            // æ›´æ–°æ ‡é¢˜
            gameTitle.textContent = `ğŸ¡ ${state.title}`;

            // é‡ç½®è½¬ç›˜è§’åº¦
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';

            // ç»˜åˆ¶è½¬ç›˜
            drawWheel();

            // åˆ‡æ¢åˆ°æ¸¸æˆé¡µé¢
            showPage(3);
        }

        function initWheelCanvas() {
            // æ ¹æ®å±å¹•å®½åº¦åŠ¨æ€è®¾ç½®å°ºå¯¸
            const screenWidth = window.innerWidth;
            const size = screenWidth < 400 ? 280 : 320; // æ‰‹æœºä¸Šç”¨ 280ï¼Œç”µè„‘ä¸Šç”¨ 320
            const dpr = window.devicePixelRatio || 1; // è·å–è®¾å¤‡åƒç´ æ¯”

            wheelCanvas.width = size * dpr;
            wheelCanvas.height = size * dpr;
            wheelCanvas.style.width = size + 'px';
            wheelCanvas.style.height = size + 'px';

            // åˆå§‹åŒ– Canvas ä¸Šä¸‹æ–‡
            wheelCtx = wheelCanvas.getContext('2d');

            // ç¼©æ”¾ Canvas ä¸Šä¸‹æ–‡ä»¥åŒ¹é…è®¾å¤‡åƒç´ æ¯”
            wheelCtx.scale(dpr, dpr);
        }

        function drawWheel() {
            // ä½¿ç”¨é€»è¾‘å°ºå¯¸ï¼ˆCSS åƒç´ ï¼‰è€Œä¸æ˜¯ç‰©ç†åƒç´ 
            const size = parseFloat(wheelCanvas.style.width);
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size / 2 - 5;

            // ä¿å­˜å½“å‰çŠ¶æ€ï¼Œé‡ç½®å˜æ¢çŸ©é˜µæ¥æ¸…ç©ºç”»å¸ƒï¼Œç„¶åæ¢å¤
            wheelCtx.save();
            wheelCtx.setTransform(1, 0, 0, 1, 0, 0);
            wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
            wheelCtx.restore();

            const dpr = window.devicePixelRatio || 1;

            // æ ¹æ®ä¸»é¢˜é€‰æ‹©é¢œè‰²
            let colors = segmentColors;
            if (state.theme === 'chinese') {
                colors = chineseColors;
            } else if (state.theme === 'cartoon') {
                colors = cartoonColors;
            }

            let currentAngle = -90; // ä»é¡¶éƒ¨å¼€å§‹

            state.options.forEach((option, index) => {
                const percentage = option.probability / 100;
                const angle = percentage * 2 * Math.PI;

                // ç»˜åˆ¶æ‰‡å½¢
                wheelCtx.beginPath();
                wheelCtx.moveTo(centerX, centerY);
                wheelCtx.arc(centerX, centerY, radius, currentAngle, currentAngle + angle);
                wheelCtx.closePath();

                // å¡«å……é¢œè‰²
                wheelCtx.fillStyle = colors[index % colors.length];
                wheelCtx.fill();

                // ç»˜åˆ¶è¾¹æ¡†
                wheelCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                wheelCtx.lineWidth = 2;
                wheelCtx.stroke();

                // ç»˜åˆ¶æ–‡å­—
                wheelCtx.save();
                wheelCtx.translate(centerX, centerY);
                wheelCtx.rotate(currentAngle + angle / 2);
                wheelCtx.textAlign = 'center';
                wheelCtx.textBaseline = 'middle';
                wheelCtx.fillStyle = 'white';
                wheelCtx.font = 'bold 18px Arial, sans-serif';
                wheelCtx.shadowColor = 'rgba(0, 0, 0, 0.5)';
                wheelCtx.shadowBlur = 4;
                wheelCtx.shadowOffsetX = 1;
                wheelCtx.shadowOffsetY = 1;

                // æ–‡å­—æ”¾åœ¨åŠå¾„çš„ 2/3 å¤„
                const textRadius = radius * 0.65;
                wheelCtx.fillText(option.name, textRadius, 0);
                wheelCtx.restore();

                currentAngle += angle;
            });

            // ç»˜åˆ¶å¤–åœˆè¾¹æ¡†
            wheelCtx.beginPath();
            wheelCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            wheelCtx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            wheelCtx.lineWidth = 4;
            wheelCtx.stroke();
        }

        // ============ éŸ³æ•ˆç³»ç»Ÿ ============
        let audioContext = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // æ’­æ”¾è½¬åŠ¨éŸ³æ•ˆï¼ˆå˜€å˜€å£°ï¼‰
        function playTickSound() {
            const ctx = initAudio();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);

            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.1);
        }

        // æ’­æ”¾ä¸­å¥–éŸ³æ•ˆï¼ˆæ¬¢å¿«çš„éŸ³ä¹ï¼‰
        function playWinSound() {
            const ctx = initAudio();

            // æ’­æ”¾ä¸€æ®µæ¬¢å¿«çš„æ—‹å¾‹
            const melody = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
            const rhythm = [0, 0.15, 0.3, 0.5];

            melody.forEach((freq, i) => {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = freq;
                oscillator.type = 'sine';

                const startTime = ctx.currentTime + rhythm[i];
                gainNode.gain.setValueAtTime(0.2, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);

                oscillator.start(startTime);
                oscillator.stop(startTime + 0.3);
            });

            // æ·»åŠ ç¶éŸ³æ•ˆæœ
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.frequency.value = 523.25 * (1 + i * 0.1);
                    osc.type = 'triangle';

                    gain.gain.setValueAtTime(0.15, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);

                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.2);
                }, i * 100);
            }
        }

        // ============ æŠ½å¥–é€»è¾‘ ============
        let tickTimeouts = [];

        function spin() {
            if (state.isSpinning) return;
            if (state.chancesLeft <= 0) {
                noChancesModal.classList.add('show');
                return;
            }

            state.isSpinning = true;
            spinBtn.disabled = true;
            state.chancesLeft--;
            updateChancesDisplay();

            // åˆå§‹åŒ–éŸ³é¢‘ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾ï¼‰
            initAudio();

            // æ’­æ”¾è½¬åŠ¨éŸ³æ•ˆ - ä»å¿«åˆ°æ…¢ï¼Œæ¨¡æ‹Ÿè½¬ç›˜å‡é€Ÿ
            // æ€»æ—¶é—´3ç§’ï¼ŒéŸ³æ•ˆé—´éš”é€æ¸å¢åŠ 
            const tickSchedule = [
                // å‰1ç§’ï¼šå¿«é€Ÿ (æ¯100ms)
                0, 100, 200, 300, 400, 500, 600, 700, 800, 900,
                // ä¸­é—´1ç§’ï¼šä¸­é€Ÿ (æ¯150ms)
                1050, 1200, 1350, 1500, 1650, 1800, 1950,
                // æœ€å1ç§’ï¼šæ…¢é€Ÿ (æ¯200ms)
                2150, 2350, 2550, 2750,
                // æœ€åå‡ å£°
                2900, 2950
            ];

            tickSchedule.forEach(delay => {
                const timeout = setTimeout(() => {
                    playTickSound();
                }, delay);
                tickTimeouts.push(timeout);
            });

            // æ ¹æ®æ¦‚ç‡é€‰æ‹©ç»“æœ
            const result = selectByProbability();

            // é‡ç½®è½¬ç›˜åˆ°0åº¦ï¼ˆå…ˆå¿«é€Ÿå¤ä½ï¼‰
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';

            // å¼ºåˆ¶æµè§ˆå™¨åº”ç”¨ä¸Šé¢çš„æ ·å¼
            wheel.offsetHeight; // è§¦å‘é‡æ’

            // ç„¶åå¼€å§‹æ—‹è½¬åŠ¨ç”»
            wheel.style.transition = 'transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)';

            // è®¡ç®—ç›®æ ‡è§’åº¦ï¼šå§‹ç»ˆé¡ºæ—¶é’ˆæ—‹è½¬
            // åŸºç¡€åœˆæ•° + ç»“æœè§’åº¦
            const baseAngle = calculateTargetAngle(result);
            const totalRotation = 360 * 8 + (360 - baseAngle); // 8åœˆ + ç›®æ ‡è§’åº¦

            wheel.style.transform = `rotate(${totalRotation}deg)`;

            // 3ç§’åæ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                showResult(result);
                state.isSpinning = false;
                spinBtn.disabled = false;
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                tickTimeouts.forEach(t => clearTimeout(t));
                tickTimeouts = [];
            }, 3000);
        }

        function selectByProbability() {
            const random = Math.random() * 100;
            let cumulative = 0;

            for (let i = 0; i < state.options.length; i++) {
                cumulative += state.options[i].probability;
                if (random <= cumulative) {
                    return i;
                }
            }

            return state.options.length - 1;
        }

        function calculateTargetAngle(resultIndex) {
            // è®¡ç®—æ¯ä¸ªæ‰‡å½¢çš„èµ·å§‹è§’åº¦ï¼ˆä»é¡¶éƒ¨å¼€å§‹ï¼Œ-90åº¦ï¼‰
            let cumulativeAngle = 0;
            for (let i = 0; i < resultIndex; i++) {
                cumulativeAngle += (state.options[i].probability / 100) * 360;
            }
            // è®¡ç®—è¯¥æ‰‡å½¢ä¸­å¿ƒçš„è§’åº¦
            const resultAngle = cumulativeAngle + (state.options[resultIndex].probability / 100) * 360 / 2;
            // æŒ‡é’ˆåœ¨é¡¶éƒ¨ï¼ˆ0åº¦ï¼‰ï¼Œè½¬ç›˜éœ€è¦æ—‹è½¬ä½¿è¯¥è§’åº¦å¯¹å‡†é¡¶éƒ¨
            // ç”±äº Canvas ä» -90 åº¦å¼€å§‹ç»˜åˆ¶ï¼Œéœ€è¦è°ƒæ•´
            return resultAngle - 90;
        }

        function showResult(resultIndex) {
            const result = state.options[resultIndex];
            resultText.textContent = `æ‚¨æŠ½ä¸­äº†ï¼š${result.name}`;
            resultModal.classList.add('show');

            // æ’­æ”¾ä¸­å¥–éŸ³æ•ˆ
            playWinSound();

            // æ’­æ”¾çƒŸèŠ±
            launchFireworks();
        }

        function updateChancesDisplay() {
            chancesLeftEl.textContent = state.chancesLeft;
        }

        // ============ çƒŸèŠ±æ•ˆæœ ============
        let fireworks = [];

        function resizeFireworksCanvas() {
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
        }

        function launchFireworks() {
            // æ¸…ç©ºä¹‹å‰çš„çƒŸèŠ±
            fireworks = [];

            // åˆ›å»ºå¤šä¸ªçƒŸèŠ±
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createFirework();
                }, i * 200);
            }

            // å¼€å§‹åŠ¨ç”»
            animateFireworks();
        }

        function createFirework() {
            const x = Math.random() * fireworksCanvas.width;
            const y = Math.random() * fireworksCanvas.height * 0.5;
            const color = `hsl(${Math.random() * 360}, 100%, 50%)`;
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * 2 * i) / particleCount;
                const velocity = 2 + Math.random() * 4;
                fireworks.push({
                    x,
                    y,
                    vx: Math.cos(angle) * velocity,
                    vy: Math.sin(angle) * velocity,
                    alpha: 1,
                    color,
                    decay: 0.01 + Math.random() * 0.02
                });
            }
        }

        function animateFireworks() {
            fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);

            fireworks = fireworks.filter(fw => fw.alpha > 0);

            fireworks.forEach(fw => {
                fireworksCtx.globalAlpha = fw.alpha;
                fireworksCtx.fillStyle = fw.color;
                fireworksCtx.beginPath();
                fireworksCtx.arc(fw.x, fw.y, 3, 0, Math.PI * 2);
                fireworksCtx.fill();

                fw.x += fw.vx;
                fw.y += fw.vy;
                fw.vy += 0.05; // é‡åŠ›
                fw.alpha -= fw.decay;
            });

            if (fireworks.length > 0) {
                requestAnimationFrame(animateFireworks);
            } else {
                fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
            }
        }

        // ============ çŠ¶æ€ä¿å­˜/åŠ è½½ ============
        function saveState() {
            const rows = optionsContainer.querySelectorAll('.option-row');
            state.options = Array.from(rows).map(row => ({
                name: row.querySelector('.option-name').value,
                probability: parseInt(row.querySelector('.option-prob').value) || 0
            }));
            state.title = wheelTitleInput.value;

            localStorage.setItem('luckyWheelState', JSON.stringify(state));
        }

        function loadState() {
            // ä¼˜å…ˆä½¿ç”¨åµŒå…¥çš„çŠ¶æ€ï¼ˆç”¨äºå¯¼å‡ºçš„ HTML æ–‡ä»¶ï¼‰
            if (window.EMBEDDED_STATE) {
                Object.assign(state, window.EMBEDDED_STATE);
                // æ ‡è®°ä¸ºå¯¼å‡ºæ¨¡å¼ï¼Œç›´æ¥æ˜¾ç¤ºè½¬ç›˜ç•Œé¢
                state.isExported = true;
                return;
            }

            // å¦åˆ™ä» localStorage åŠ è½½
            const saved = localStorage.getItem('luckyWheelState');
            if (saved) {
                const loaded = JSON.parse(saved);
                Object.assign(state, loaded);
            }
        }

        // ============ å¯¼å‡º HTML ============
        function exportHTML() {
            saveState();

            // è·å–å½“å‰ HTML
            let htmlContent = document.documentElement.outerHTML;

            // åœ¨ HTML ä¸­åµŒå…¥å½“å‰é…ç½®çŠ¶æ€
            // è¿™æ ·å¯¼å‡ºçš„æ–‡ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ localStorage
            const embeddedState = JSON.stringify({
                options: state.options,
                title: state.title,
                theme: state.theme
            });

            // åœ¨ script æ ‡ç­¾å‰æ·»åŠ åµŒå…¥çš„çŠ¶æ€
            const scriptIndex = htmlContent.indexOf('<script>');
            if (scriptIndex !== -1) {
                const embeddedScript = `<script>window.EMBEDDED_STATE = ${embeddedState};<\/script>`;
                htmlContent = htmlContent.slice(0, scriptIndex) + embeddedScript + htmlContent.slice(scriptIndex);
            }

            // åˆ›å»ºä¸‹è½½
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.title || 'å¹¸è¿è½¬ç›˜'}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============ å¯åŠ¨ ============
        init();
    </script>
</body>
</html>